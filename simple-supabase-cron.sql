-- ğŸ”¥ ç®€åŒ–ç‰ˆSupabaseå®šæ—¶ä»»åŠ¡è®¾ç½®
-- åœ¨Supabase SQL Editorä¸­æ‰§è¡Œ

-- ç¬¬1æ­¥ï¼šå¯ç”¨pg_cronæ‰©å±•
CREATE EXTENSION IF NOT EXISTS pg_cron;

-- ç¬¬2æ­¥ï¼šæ¸…ç†ç°æœ‰ä»»åŠ¡
SELECT cron.unschedule('rss-fetch-daily') WHERE EXISTS (
    SELECT 1 FROM cron.job WHERE jobname = 'rss-fetch-daily'
);

-- ç¬¬3æ­¥ï¼šåˆ›å»ºç®€å•çš„å®šæ—¶ä»»åŠ¡
-- æ¯å¤©ä¸Šåˆ9ç‚¹ï¼ˆUTC+8 = UTC 1:00ï¼‰æ‰§è¡Œ
SELECT cron.schedule(
    'rss-fetch-daily',
    '0 1 * * *',
    $$
    INSERT INTO cron_rss_logs (job_name, status, message) 
    VALUES ('rss-fetch-daily', 'triggered', 'Daily RSS fetch triggered at ' || NOW());
    $$
);

-- ç¬¬4æ­¥ï¼šåˆ›å»ºæ—¥å¿—è¡¨
CREATE TABLE IF NOT EXISTS cron_rss_logs (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    job_name TEXT,
    executed_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    status TEXT,
    message TEXT
);

-- ç¬¬5æ­¥ï¼šéªŒè¯å®šæ—¶ä»»åŠ¡
SELECT 
    jobname,
    schedule,
    active,
    command
FROM cron.job 
WHERE jobname = 'rss-fetch-daily';

-- ç¬¬6æ­¥ï¼šæ‰‹åŠ¨æµ‹è¯•
INSERT INTO cron_rss_logs (job_name, status, message) 
VALUES ('manual-test', 'success', 'Manual test at ' || NOW());

-- æŸ¥çœ‹æ—¥å¿—
SELECT * FROM cron_rss_logs ORDER BY executed_at DESC LIMIT 5;

-- å®Œæˆæç¤º
SELECT 'âœ… åŸºç¡€å®šæ—¶ä»»åŠ¡å·²è®¾ç½®ï¼' as result;