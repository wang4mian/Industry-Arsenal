# ğŸ”¥ Supabase pg_cron å®šæ—¶ä»»åŠ¡è®¾ç½®æŒ‡å—

## å‡†å¤‡å·¥ä½œ

### 1. ç¡®è®¤Supabaseè®¡åˆ’
- pg_cronæ‰©å±•éœ€è¦**Proè®¡åˆ’**æˆ–æ›´é«˜ç‰ˆæœ¬
- å…è´¹ç‰ˆæœ¬ä¸æ”¯æŒpg_cron

### 2. ç™»å½•Supabaseæ§åˆ¶å°
1. è®¿é—® [supabase.com](https://supabase.com)
2. è¿›å…¥ä½ çš„é¡¹ç›®æ§åˆ¶å°
3. ç‚¹å‡»å·¦ä¾§ **SQL Editor**

## è®¾ç½®æ­¥éª¤

### æ­¥éª¤1: æ‰§è¡ŒåŸºç¡€å®šæ—¶ä»»åŠ¡
åœ¨SQL Editorä¸­æ‰§è¡Œ `simple-supabase-cron.sql` çš„å†…å®¹ï¼š

```sql
-- å¯ç”¨pg_cronæ‰©å±•
CREATE EXTENSION IF NOT EXISTS pg_cron;

-- åˆ›å»ºæ—¥å¿—è¡¨
CREATE TABLE IF NOT EXISTS cron_rss_logs (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    job_name TEXT,
    executed_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    status TEXT,
    message TEXT
);

-- åˆ›å»ºå®šæ—¶ä»»åŠ¡
SELECT cron.schedule(
    'rss-fetch-daily',
    '0 1 * * *',  -- æ¯å¤©UTC 1:00 (åŒ—äº¬æ—¶é—´9:00)
    $$
    INSERT INTO cron_rss_logs (job_name, status, message) 
    VALUES ('rss-fetch-daily', 'triggered', 'Daily RSS fetch triggered at ' || NOW());
    $$
);
```

### æ­¥éª¤2: éªŒè¯å®šæ—¶ä»»åŠ¡
```sql
-- æŸ¥çœ‹å·²åˆ›å»ºçš„å®šæ—¶ä»»åŠ¡
SELECT jobname, schedule, active, command 
FROM cron.job 
WHERE jobname = 'rss-fetch-daily';

-- æŸ¥çœ‹æ‰§è¡Œæ—¥å¿—
SELECT * FROM cron_rss_logs ORDER BY executed_at DESC LIMIT 10;
```

### æ­¥éª¤3: è®¾ç½®å®é™…çš„RSSæŠ“å–ä»»åŠ¡
å¦‚æœæ­¥éª¤1æˆåŠŸï¼Œç»§ç»­æ‰§è¡Œå®Œæ•´ç‰ˆæœ¬ï¼š

```sql
-- æ›´æ–°å®šæ—¶ä»»åŠ¡ä¸ºå®é™…çš„RSSæŠ“å–
SELECT cron.unschedule('rss-fetch-daily');

-- åˆ›å»ºå®Œæ•´çš„RSSæŠ“å–ä»»åŠ¡
SELECT cron.schedule(
    'fetch-rss-3d-print',
    '0 1 * * *',
    $$
    SELECT net.http_post(
        'https://ewjzuiwhvyfmzrmpnzid.supabase.co/functions/v1/fetch-rss',
        '{"rssUrl": "https://news.google.com/rss/search?q=3D+printing&hl=zh-CN&gl=CN&ceid=CN:zh-Hans", "sourceName": "3D Print", "verticalName": "3Dæ‰“å°"}',
        'application/json'
    )
    $$
);
```

## æ•…éšœæ’é™¤

### é—®é¢˜1: pg_cronæ‰©å±•æ— æ³•å¯ç”¨
```
ERROR: extension "pg_cron" is not available
```

**è§£å†³æ–¹æ¡ˆ**: 
- ç¡®è®¤ä½ çš„Supabaseè®¡åˆ’æ”¯æŒpg_cron
- è”ç³»Supabaseæ”¯æŒå¯ç”¨æ‰©å±•

### é—®é¢˜2: net.http_postå‡½æ•°ä¸å­˜åœ¨
```
ERROR: function net.http_post does not exist
```

**è§£å†³æ–¹æ¡ˆ**: 
- å…ˆä½¿ç”¨åŸºç¡€ç‰ˆæœ¬æµ‹è¯•
- æˆ–ä½¿ç”¨webhookè§¦å‘å™¨

### é—®é¢˜3: å®šæ—¶ä»»åŠ¡ä¸æ‰§è¡Œ
```sql
-- æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
SELECT * FROM cron.job WHERE jobname LIKE '%rss%';

-- æ£€æŸ¥æ‰§è¡Œæ—¥å¿—
SELECT * FROM cron.job_run_details 
WHERE jobname LIKE '%rss%' 
ORDER BY start_time DESC LIMIT 10;
```

## å¤‡é€‰æ–¹æ¡ˆ

å¦‚æœpg_cronä¸å¯ç”¨ï¼Œå¯ä»¥ä½¿ç”¨ï¼š

1. **Supabase Database Webhooks**
2. **å¤–éƒ¨cronæœåŠ¡**ï¼ˆå¦‚cron-job.orgï¼‰
3. **GitHub Actions**
4. **Vercel Cron Jobs**

## éªŒè¯RSSæŠ“å–

```sql
-- æŸ¥çœ‹æœ€æ–°æ–‡ç« 
SELECT title, vertical_name, created_at 
FROM articles 
ORDER BY created_at DESC 
LIMIT 20;

-- æŸ¥çœ‹å„é¢†åŸŸæ–‡ç« ç»Ÿè®¡
SELECT vertical_name, COUNT(*) as count 
FROM articles 
GROUP BY vertical_name 
ORDER BY count DESC;
```

## å½“å‰çŠ¶æ€

âœ… RSSæŠ“å–åŠŸèƒ½å·²å®Œå…¨å·¥ä½œ
âœ… å®šæ—¶ä»»åŠ¡SQLè„šæœ¬å·²å‡†å¤‡
â³ éœ€è¦åœ¨Supabaseæ§åˆ¶å°ä¸­æ‰§è¡Œ

**ä¸‹ä¸€æ­¥**: åœ¨Supabase SQL Editorä¸­æ‰§è¡Œ `simple-supabase-cron.sql` å¼€å§‹è®¾ç½®ï¼