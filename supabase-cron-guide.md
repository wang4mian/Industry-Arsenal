# 🔥 Supabase pg_cron 定时任务设置指南

## 准备工作

### 1. 确认Supabase计划
- pg_cron扩展需要**Pro计划**或更高版本
- 免费版本不支持pg_cron

### 2. 登录Supabase控制台
1. 访问 [supabase.com](https://supabase.com)
2. 进入你的项目控制台
3. 点击左侧 **SQL Editor**

## 设置步骤

### 步骤1: 执行基础定时任务
在SQL Editor中执行 `simple-supabase-cron.sql` 的内容：

```sql
-- 启用pg_cron扩展
CREATE EXTENSION IF NOT EXISTS pg_cron;

-- 创建日志表
CREATE TABLE IF NOT EXISTS cron_rss_logs (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    job_name TEXT,
    executed_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    status TEXT,
    message TEXT
);

-- 创建定时任务
SELECT cron.schedule(
    'rss-fetch-daily',
    '0 1 * * *',  -- 每天UTC 1:00 (北京时间9:00)
    $$
    INSERT INTO cron_rss_logs (job_name, status, message) 
    VALUES ('rss-fetch-daily', 'triggered', 'Daily RSS fetch triggered at ' || NOW());
    $$
);
```

### 步骤2: 验证定时任务
```sql
-- 查看已创建的定时任务
SELECT jobname, schedule, active, command 
FROM cron.job 
WHERE jobname = 'rss-fetch-daily';

-- 查看执行日志
SELECT * FROM cron_rss_logs ORDER BY executed_at DESC LIMIT 10;
```

### 步骤3: 设置实际的RSS抓取任务
如果步骤1成功，继续执行完整版本：

```sql
-- 更新定时任务为实际的RSS抓取
SELECT cron.unschedule('rss-fetch-daily');

-- 创建完整的RSS抓取任务
SELECT cron.schedule(
    'fetch-rss-3d-print',
    '0 1 * * *',
    $$
    SELECT net.http_post(
        'https://ewjzuiwhvyfmzrmpnzid.supabase.co/functions/v1/fetch-rss',
        '{"rssUrl": "https://news.google.com/rss/search?q=3D+printing&hl=zh-CN&gl=CN&ceid=CN:zh-Hans", "sourceName": "3D Print", "verticalName": "3D打印"}',
        'application/json'
    )
    $$
);
```

## 故障排除

### 问题1: pg_cron扩展无法启用
```
ERROR: extension "pg_cron" is not available
```

**解决方案**: 
- 确认你的Supabase计划支持pg_cron
- 联系Supabase支持启用扩展

### 问题2: net.http_post函数不存在
```
ERROR: function net.http_post does not exist
```

**解决方案**: 
- 先使用基础版本测试
- 或使用webhook触发器

### 问题3: 定时任务不执行
```sql
-- 检查任务状态
SELECT * FROM cron.job WHERE jobname LIKE '%rss%';

-- 检查执行日志
SELECT * FROM cron.job_run_details 
WHERE jobname LIKE '%rss%' 
ORDER BY start_time DESC LIMIT 10;
```

## 备选方案

如果pg_cron不可用，可以使用：

1. **Supabase Database Webhooks**
2. **外部cron服务**（如cron-job.org）
3. **GitHub Actions**
4. **Vercel Cron Jobs**

## 验证RSS抓取

```sql
-- 查看最新文章
SELECT title, vertical_name, created_at 
FROM articles 
ORDER BY created_at DESC 
LIMIT 20;

-- 查看各领域文章统计
SELECT vertical_name, COUNT(*) as count 
FROM articles 
GROUP BY vertical_name 
ORDER BY count DESC;
```

## 当前状态

✅ RSS抓取功能已完全工作
✅ 定时任务SQL脚本已准备
⏳ 需要在Supabase控制台中执行

**下一步**: 在Supabase SQL Editor中执行 `simple-supabase-cron.sql` 开始设置！