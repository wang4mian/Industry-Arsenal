# 🔥 RSS自动化系统完整指南

> **重要**：这是OSINT工作台V3.0的RSS自动抓取系统完整实现指南。包含所有踩过的坑和最终解决方案，避免重复折腾。

## 📋 系统概览

### 最终架构
```
用户打开页面 
    ↓
前端自动检查(24小时间隔)
    ↓  
调用Supabase Edge Function
    ↓
从rss_sources表读取活跃源
    ↓
逐个抓取RSS并解析
    ↓
存储到articles表
    ↓
前端显示最新文章
```

### 关键组件
- **前端自动触发**: index.astro中的autoFetchRSS()函数
- **RSS抓取逻辑**: Supabase Edge Function (fetch-rss)
- **数据源管理**: rss_sources表
- **文章存储**: articles表
- **定时控制**: localStorage + 24小时间隔

---

## 🎯 核心实现

### 1. RSS抓取Edge Function
**位置**: Supabase Functions > fetch-rss
**功能**: 解析RSS XML并存储到数据库

```typescript
// 关键解析逻辑 - 接受Google News重定向链接
if (title && title.length > 3 && link && link.startsWith('http')) {
  const article = {
    title: title,
    original_article_link: link,  // ✅ 接受Google重定向链接
    vertical_name: verticalName,
    summary_ai: description || `来源：${sourceName}`,
    score_ai: Math.floor(Math.random() * 3) + 7,
    is_selected: false
  }
  articles.push(article)
}
```

### 2. 前端自动抓取
**位置**: `/src/pages/index.astro` (第1297-1361行)

```javascript
async function autoFetchRSS() {
  const lastFetch = localStorage.getItem('lastRSSFetch')
  const now = Date.now()
  const oneDay = 24 * 60 * 60 * 1000
  
  if (!lastFetch || (now - parseInt(lastFetch)) > oneDay) {
    console.log('🔥 检测到需要自动抓取RSS...')
    await fetchAllRssSources()
    localStorage.setItem('lastRSSFetch', now.toString())
  }
}
```

### 3. RSS源管理表
**表名**: `rss_sources`
**作用**: 集中管理所有RSS源，通过is_active控制

```sql
CREATE TABLE rss_sources (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name TEXT NOT NULL,
  url TEXT NOT NULL UNIQUE,
  is_active BOOLEAN DEFAULT TRUE,
  vertical_name TEXT
);
```

---

## 🛠️ 完整部署步骤

### 步骤1: 部署Edge Function
1. 登录Supabase控制台
2. 进入Functions页面
3. 创建新函数: `fetch-rss`
4. 复制 `fixed-rss-parser.ts` 的内容
5. 部署函数

### 步骤2: 设置数据库表
在Supabase SQL Editor中执行：
```sql
-- 执行 create-tables.sql 的内容
-- 包含 articles 表和 rss_sources 表的创建
```

### 步骤3: 添加RSS源
```sql
INSERT INTO rss_sources (name, url, is_active, vertical_name) VALUES
('3D Print', 'https://news.google.com/rss/search?q=3D+printing&hl=zh-CN&gl=CN&ceid=CN:zh-Hans', true, '3D打印'),
('SEO News', 'https://news.google.com/rss/search?q=SEO&hl=zh-CN&gl=CN&ceid=CN:zh-Hans', true, 'SEO');
```

### 步骤4: 前端自动抓取已集成
- ✅ 已在index.astro中实现
- ✅ 页面加载时自动检查
- ✅ 24小时间隔控制
- ✅ 用户友好的通知

---

## 🔧 关键代码位置

### 前端代码
- **主页面**: `/src/pages/index.astro`
- **自动抓取函数**: 第1297-1361行
- **手动抓取函数**: 第1044-1127行

### 后端代码  
- **Edge Function**: Supabase Functions > fetch-rss
- **SQL表结构**: `create-tables.sql`
- **RSS源数据**: `import-rss-sources.sql`

### 配置文件
- **Supabase配置**: 第617-619行
- **RSS源管理**: rss_sources表
- **定时控制**: localStorage.lastRSSFetch

---

## 🚨 踩过的坑和解决方案

### 坑1: Google News重定向链接被过滤
**问题**: 初始代码过滤掉了Google News的重定向链接
**解决**: 修改验证逻辑，接受所有http开头的链接
```javascript
// ❌ 错误的过滤逻辑
if (link.includes('news.google.com/rss/articles/')) {
  continue; // 跳过Google重定向
}

// ✅ 正确的逻辑
if (title && title.length > 3 && link && link.startsWith('http')) {
  // 接受所有有效链接
}
```

### 坑2: 定时任务过度复杂化
**问题**: 
- 尝试使用pg_cron (需要Pro计划)
- 考虑GitHub Actions (需要额外配置)
- 硬编码多个定时任务

**解决**: 前端localStorage + 页面加载检查
- ✅ 完全免费
- ✅ 即时生效  
- ✅ 无需服务器配置
- ✅ 用户控制

### 坑3: RSS源硬编码管理困难
**问题**: 在定时任务中硬编码RSS URL
**解决**: 使用rss_sources表动态管理
```javascript
// ❌ 硬编码方式
const rssUrls = [
  'https://news.google.com/rss/search?q=3D+printing...',
  'https://news.google.com/rss/search?q=SEO...'
]

// ✅ 动态方式
const { data: rssSources } = await supabase
  .from('rss_sources')
  .select('*')
  .eq('is_active', true)
```

### 坑4: DOMParser在Deno环境不可用
**问题**: 尝试使用浏览器API解析XML
**解决**: 改用正则表达式解析
```javascript
// ❌ 在Deno Edge Function中不可用
const parser = new DOMParser()
const doc = parser.parseFromString(xmlText, 'application/xml')

// ✅ 正确的解析方法
const itemPattern = /<item[^>]*>([\s\S]*?)<\/item>/gi
const itemMatches = [...xmlText.matchAll(itemPattern)]
```

---

## 🎯 运行方式

### 开发环境
```bash
cd /Users/simianwang/Desktop/产业编译工作室/osint-workstation
npm run dev
# 访问 http://localhost:4321
```

### 自动抓取触发条件
1. **用户打开主页** (`index.astro`)
2. **检查时间间隔** (超过24小时)
3. **自动执行抓取** (无需用户操作)
4. **显示进度通知** (右上角提示)

### 手动抓取
- 点击页面上的 "抓取RSS" 按钮
- 或在控制台执行: `fetchAllRssSources()`

---

## 📊 数据流向

### RSS源 → 文章数据
```
rss_sources表 (RSS源配置)
    ↓
Edge Function (RSS解析)
    ↓  
articles表 (文章数据)
    ↓
前端页面 (用户界面)
```

### 字段映射
```
RSS XML          →  articles表字段
<title>          →  title
<link>           →  original_article_link  
<description>    →  summary_ai
RSS源名称         →  vertical_name
随机7-9分         →  score_ai
默认false        →  is_selected
```

---

## 🔍 故障排除

### 问题1: 自动抓取不工作
**检查步骤**:
1. 打开浏览器控制台，看是否有错误
2. 检查localStorage: `localStorage.getItem('lastRSSFetch')`
3. 手动触发: `autoFetchRSS()`

### 问题2: RSS抓取返回空数据
**检查步骤**:
1. 确认rss_sources表有活跃数据: `SELECT * FROM rss_sources WHERE is_active = true`
2. 测试单个RSS源: 直接访问RSS URL
3. 检查Edge Function日志

### 问题3: 文章不显示
**检查步骤**:
1. 确认articles表有数据: `SELECT COUNT(*) FROM articles`
2. 检查前端Supabase连接配置
3. 查看浏览器网络请求是否成功

### 问题4: 数据库连接失败
**检查步骤**:
1. 确认Supabase URL和API Key正确
2. 检查RLS (行级安全) 是否已禁用
3. 确认表权限设置正确

---

## 📝 管理RSS源

### 添加新RSS源
```sql
INSERT INTO rss_sources (name, url, is_active, vertical_name) VALUES
('新源名称', 'https://news.google.com/rss/search?q=关键词&hl=zh-CN&gl=CN&ceid=CN:zh-Hans', true, '领域名称');
```

### 禁用RSS源
```sql
UPDATE rss_sources SET is_active = false WHERE name = '源名称';
```

### 查看抓取统计
```sql
-- 各领域文章数量
SELECT vertical_name, COUNT(*) as count 
FROM articles 
GROUP BY vertical_name 
ORDER BY count DESC;

-- 最近文章
SELECT title, vertical_name, created_at 
FROM articles 
ORDER BY created_at DESC 
LIMIT 20;
```

---

## 🎉 系统优势

### ✅ 完全自动化
- 用户打开页面即自动更新
- 24小时智能间隔控制  
- 无需手动维护

### ✅ 易于管理
- 数据库表管理RSS源
- 通过is_active控制开关
- 集中式配置

### ✅ 用户友好
- 实时进度通知
- 详细的控制台日志
- 优雅的错误处理

### ✅ 高可靠性
- 容错机制完善
- 失败重试逻辑
- 数据一致性保证

---

## 🚀 未来扩展

### 可能的改进方向
1. **真实AI评分**: 替换随机评分为真实AI分析
2. **更多RSS源**: 支持非Google News的RSS格式
3. **文章去重**: 基于标题或URL的智能去重
4. **定时优化**: 根据RSS源更新频率调整抓取间隔
5. **内容增强**: 自动提取文章全文和图片

### 扩展RSS源类型
当前支持Google News格式，如需支持其他格式，修改Edge Function中的解析逻辑即可。

---

## 📚 相关文件清单

### 核心文件 (必需)
- `src/pages/index.astro` - 主页面 + 自动抓取逻辑
- `create-tables.sql` - 数据库表结构
- `fixed-rss-parser.ts` - Edge Function代码

### 参考文件 (可选)
- `简单定时任务方案.md` - 定时任务方案对比
- `supabase-cron-guide.md` - pg_cron实现方案
- `cron-setup-guide.md` - 各种定时任务方案

### 调试文件 (历史)
- `super-simple-debug.ts` - 调试RSS解析
- `debug-rss-parser.ts` - 详细调试信息
- `simple-fetch-rss.ts` - 简化版解析器

---

## 🎯 总结

**这套RSS自动化系统已完全解决以下需求**:
1. ✅ 自动抓取多个RSS源
2. ✅ 智能定时控制 (24小时间隔)
3. ✅ 集中管理RSS源配置
4. ✅ 用户友好的界面体验
5. ✅ 数据持久化存储
6. ✅ 错误处理和恢复

**关键成功因素**:
- 选择前端触发而非复杂的服务器定时任务
- 使用数据库表管理RSS源而非硬编码
- 接受Google News重定向链接而非过度过滤
- 简单可靠的localStorage时间控制

**以后遇到类似需求，直接参考这个文档，不要重新折腾！**