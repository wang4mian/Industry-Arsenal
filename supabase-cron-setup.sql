-- ğŸ”¥ Supabase pg_cron å®šæ—¶ä»»åŠ¡è®¾ç½®
-- åœ¨Supabase SQL Editorä¸­æ‰§è¡Œæ­¤è„šæœ¬

-- ç¬¬1æ­¥ï¼šå¯ç”¨å¿…è¦çš„æ‰©å±•
CREATE EXTENSION IF NOT EXISTS pg_cron;
CREATE EXTENSION IF NOT EXISTS http;

-- ç¬¬2æ­¥ï¼šæ¸…ç†ç°æœ‰çš„å®šæ—¶ä»»åŠ¡
DO $$
DECLARE
    job_record RECORD;
BEGIN
    FOR job_record IN SELECT jobname FROM cron.job WHERE jobname LIKE '%rss%' LOOP
        PERFORM cron.unschedule(job_record.jobname);
    END LOOP;
END $$;

-- ç¬¬3æ­¥ï¼šåˆ›å»ºå®šæ—¶ä»»åŠ¡ - æ¯å¤©ä¸Šåˆ9ç‚¹ï¼ˆUTC+8 = UTC 1:00ï¼‰
-- ä»»åŠ¡1: 3Dæ‰“å°RSSæŠ“å–
SELECT cron.schedule(
    'fetch-rss-3d-print',
    '0 1 * * *',  -- æ¯å¤©UTC 1:00 (åŒ—äº¬æ—¶é—´9:00)
    $$
    SELECT
        http_post(
            'https://ewjzuiwhvyfmzrmpnzid.supabase.co/functions/v1/fetch-rss',
            '{"rssUrl": "https://news.google.com/rss/search?q=3D+printing&hl=zh-CN&gl=CN&ceid=CN:zh-Hans", "sourceName": "3D Print", "verticalName": "3Dæ‰“å°"}',
            'application/json'
        )
    $$
);

-- ä»»åŠ¡2: SEO RSSæŠ“å– (å»¶è¿Ÿ5åˆ†é’Ÿ)
SELECT cron.schedule(
    'fetch-rss-seo',
    '5 1 * * *',  -- æ¯å¤©UTC 1:05
    $$
    SELECT
        http_post(
            'https://ewjzuiwhvyfmzrmpnzid.supabase.co/functions/v1/fetch-rss',
            '{"rssUrl": "https://news.google.com/rss/search?q=SEO&hl=zh-CN&gl=CN&ceid=CN:zh-Hans", "sourceName": "SEO News", "verticalName": "SEO"}',
            'application/json'
        )
    $$
);

-- ä»»åŠ¡3: å†œä¸šç§‘æŠ€RSSæŠ“å– (å»¶è¿Ÿ10åˆ†é’Ÿ)
SELECT cron.schedule(
    'fetch-rss-agritech',
    '10 1 * * *',  -- æ¯å¤©UTC 1:10
    $$
    SELECT
        http_post(
            'https://ewjzuiwhvyfmzrmpnzid.supabase.co/functions/v1/fetch-rss',
            '{"rssUrl": "https://news.google.com/rss/search?q=å†œä¸šæœºå™¨äºº&hl=zh-CN&gl=CN&ceid=CN:zh-Hans", "sourceName": "AgriTech", "verticalName": "å†œä¸šç§‘æŠ€"}',
            'application/json'
        )
    $$
);

-- ä»»åŠ¡4: æ™ºæ…§å†œä¸šRSSæŠ“å– (å»¶è¿Ÿ15åˆ†é’Ÿ)
SELECT cron.schedule(
    'fetch-rss-smart-agriculture',
    '15 1 * * *',  -- æ¯å¤©UTC 1:15
    $$
    SELECT
        http_post(
            'https://ewjzuiwhvyfmzrmpnzid.supabase.co/functions/v1/fetch-rss',
            '{"rssUrl": "https://news.google.com/rss/search?q=Smart+Agriculture&hl=en&gl=US&ceid=US:en", "sourceName": "Smart Agriculture", "verticalName": "æ™ºæ…§å†œä¸š"}',
            'application/json'
        )
    $$
);

-- ä»»åŠ¡5: å¢æåˆ¶é€ RSSæŠ“å– (å»¶è¿Ÿ20åˆ†é’Ÿ)
SELECT cron.schedule(
    'fetch-rss-additive-manufacturing',
    '20 1 * * *',  -- æ¯å¤©UTC 1:20
    $$
    SELECT
        http_post(
            'https://ewjzuiwhvyfmzrmpnzid.supabase.co/functions/v1/fetch-rss',
            '{"rssUrl": "https://news.google.com/rss/search?q=additivemanufacturing&hl=en&gl=US&ceid=US:en", "sourceName": "Additive Manufacturing", "verticalName": "å¢æåˆ¶é€ "}',
            'application/json'
        )
    $$
);

-- ç¬¬4æ­¥ï¼šéªŒè¯å®šæ—¶ä»»åŠ¡å·²åˆ›å»º
SELECT 
    jobname,
    schedule,
    active,
    jobid,
    nodename
FROM cron.job 
WHERE jobname LIKE '%rss%'
ORDER BY jobname;

-- ç¬¬5æ­¥ï¼šæŸ¥çœ‹å®šæ—¶ä»»åŠ¡æ‰§è¡Œå†å²ï¼ˆå¯é€‰ï¼‰
-- SELECT * FROM cron.job_run_details WHERE jobname LIKE '%rss%' ORDER BY start_time DESC LIMIT 10;

-- ç¬¬6æ­¥ï¼šåˆ›å»ºæ—¥å¿—è¡¨æ¥è·Ÿè¸ªå®šæ—¶ä»»åŠ¡æ‰§è¡Œ
CREATE TABLE IF NOT EXISTS cron_rss_logs (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    job_name TEXT,
    executed_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    status TEXT,
    message TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ç¬¬7æ­¥ï¼šæ‰‹åŠ¨æµ‹è¯•ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼ˆç«‹å³æ‰§è¡Œï¼‰
-- SELECT cron.schedule('test-rss-fetch', '* * * * *', 'SELECT 1;');
-- SELECT cron.unschedule('test-rss-fetch');

-- å®Œæˆï¼
SELECT 'ğŸ”¥ å®šæ—¶ä»»åŠ¡è®¾ç½®å®Œæˆï¼æ¯å¤©ä¸Šåˆ9ç‚¹è‡ªåŠ¨æŠ“å–RSSæºã€‚' as status;