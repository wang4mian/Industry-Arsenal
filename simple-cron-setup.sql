-- ğŸ”¥ ç®€åŒ–çš„å®šæ—¶ä»»åŠ¡è®¾ç½®
-- ä½¿ç”¨ pg_cron æ‰©å±•è‡ªåŠ¨è§¦å‘RSSæŠ“å–

-- é¦–å…ˆåˆ›å»ºä¸€ä¸ªç®€å•çš„è§¦å‘å‡½æ•°
CREATE OR REPLACE FUNCTION trigger_rss_fetch()
RETURNS void AS $$
BEGIN
    -- è®°å½•è§¦å‘æ—¶é—´
    INSERT INTO rss_fetch_logs (triggered_at, status) 
    VALUES (NOW(), 'triggered');
    
    -- æ›´æ–°RSSæºçš„æœ€åè§¦å‘æ—¶é—´
    UPDATE rss_sources 
    SET last_fetch_time = NOW() 
    WHERE is_active = true;
    
    -- è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤šé€»è¾‘ï¼Œæ¯”å¦‚è°ƒç”¨Edge Function
END;
$$ LANGUAGE plpgsql;

-- åˆ›å»ºæ—¥å¿—è¡¨
CREATE TABLE IF NOT EXISTS rss_fetch_logs (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    triggered_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    status TEXT,
    message TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ğŸ”¥ è®¾ç½®ç®€å•çš„å®šæ—¶ä»»åŠ¡ - æ¯å¤©ä¸Šåˆ9ç‚¹
-- æ³¨æ„ï¼šè¿™ä¸ªéœ€è¦åœ¨Supabaseæ§åˆ¶å°ä¸­æ‰‹åŠ¨è®¾ç½®
-- æˆ–è€…ä½¿ç”¨ GitHub Actions ä½œä¸ºå¤–éƒ¨å®šæ—¶å™¨

-- æŸ¥çœ‹ç°æœ‰çš„å®šæ—¶ä»»åŠ¡
SELECT * FROM cron.job WHERE jobname LIKE '%rss%';

-- æ¸…ç†æ—§çš„å®šæ—¶ä»»åŠ¡
DO $$
DECLARE
    job_record RECORD;
BEGIN
    FOR job_record IN SELECT jobname FROM cron.job WHERE jobname LIKE '%rss%' LOOP
        PERFORM cron.unschedule(job_record.jobname);
    END LOOP;
END $$;

-- ğŸ”¥ åˆ›å»ºä¸»å®šæ—¶ä»»åŠ¡ - æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡RSSæŠ“å–
SELECT cron.schedule(
    'auto-rss-fetch',
    '0 */6 * * *',  -- æ¯6å°æ—¶æ‰§è¡Œä¸€æ¬¡
    'SELECT trigger_rss_fetch();'
);

-- éªŒè¯å®šæ—¶ä»»åŠ¡å·²åˆ›å»º
SELECT jobname, schedule, command, active, nodename FROM cron.job WHERE jobname = 'auto-rss-fetch';